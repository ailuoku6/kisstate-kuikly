
# kisstate for Kuikly

**kisstate** æ˜¯ä¸€ä¸ªéµå¾ª **KISSï¼ˆKeep It Simple, Stupidï¼‰åŸåˆ™** çš„è½»é‡çº§å“åº”å¼çŠ¶æ€ç®¡ç†åº“ï¼Œ
ä¸“ä¸º **Kuikly** æ¡†æ¶é‡èº«æ‰“é€ ã€‚

å®ƒæä¾›äº†ç±»ä¼¼ **Vue / React Hooks** çš„å“åº”å¼èƒ½åŠ›ï¼Œé€šè¿‡ `kisstate`ã€`computed`ã€`watch` ç­‰ APIï¼Œ
è®©ä½ å¯ä»¥ç”¨**æä½çš„å¿ƒæ™ºè´Ÿæ‹…**å®ŒæˆçŠ¶æ€ç®¡ç†ã€æ´¾ç”ŸçŠ¶æ€å’Œå‰¯ä½œç”¨ç›‘å¬ã€‚

> ğŸ¯ è®¾è®¡ç›®æ ‡
> **ç®€å•ã€ç›´è§‚ã€å¯æ§ã€ä¸è¸©å‘**

---

## ç‰¹æ€§ âœ¨

* **æç®€ API**

   * `kisstate`
   * `kisstateList`
   * `computed`
   * `watch`
* **è‡ªåŠ¨ä¾èµ–è¿½è¸ª**

   * çŠ¶æ€å˜åŒ– â†’ ä¾èµ–è‡ªåŠ¨æ›´æ–° â†’ UI è‡ªåŠ¨åˆ·æ–°
* **Kuikly æ·±åº¦é€‚é…**

   * ä¸ `vfor` / `vif` / Page ç”Ÿå‘½å‘¨æœŸæ— ç¼åä½œ
* **æ— ä¾µå…¥å¼è®¾è®¡**

   * ä¸éœ€è¦ç»§æ‰¿åŸºç±»
   * ä¸æ±¡æŸ“ä¸šåŠ¡æ¨¡å‹
* **æ˜¾å¼ç”Ÿå‘½å‘¨æœŸç®¡ç†**

   * é€šè¿‡ `KisContext` ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…å†…å­˜æ³„æ¼

---

## å®‰è£… ğŸ“¦

```kotlin
implementation("io.github.ailuoku6.kisstate:lib:1.0.3")
```

> ç‰ˆæœ¬å·ä»¥å®é™…å‘å¸ƒä¸ºå‡†

---

## æ ¸å¿ƒæ¦‚å¿µ ğŸ§ 

### 1ï¸âƒ£ åŸºç¡€å“åº”å¼çŠ¶æ€ï¼ˆ`kisstate`ï¼‰

ä½¿ç”¨ `kisstate` å£°æ˜ä¸€ä¸ª**å¯è§‚å¯Ÿçš„åŸºç¡€çŠ¶æ€**ï¼š

```kotlin
class Counter {
    var count by kisstate(0)
}
```

è¯´æ˜ï¼š

* è‡ªåŠ¨è¿½è¸ª `count` çš„è¯»å–ä¸ä¿®æ”¹
* åœ¨ UI / computed / watch ä¸­ä½¿ç”¨éƒ½ä¼šå»ºç«‹ä¾èµ–
* çŠ¶æ€å˜åŒ–ä¼šè‡ªåŠ¨è§¦å‘ç›¸å…³æ›´æ–°

---

### 2ï¸âƒ£ å“åº”å¼åˆ—è¡¨ï¼ˆ`kisstateList`ï¼‰

åˆ—è¡¨æ˜¯ Kuikly åœºæ™¯ä¸­æœ€å¸¸è§çš„çŠ¶æ€å½¢å¼ï¼š

```kotlin
class Counter {
    var list by kisstateList<String>()
}
```

æ”¯æŒèƒ½åŠ›ï¼š

* `add / remove / clear` ç­‰å¸¸è§åˆ—è¡¨æ“ä½œ
* è‡ªåŠ¨è§¦å‘ä¾èµ–æ›´æ–°
* å¯è¢« `computed` / `watch` ä¾èµ–
* åŸç”Ÿæ”¯æŒ `vfor` ç­‰åœºæ™¯

#### âš ï¸ vfor ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼ˆéå¸¸é‡è¦ï¼‰

> **åœ¨ `vfor` ä¸­ä½¿ç”¨ `kisstateList` æ—¶ï¼Œå¿…é¡»è°ƒç”¨ `toObservableList()`**

```kotlin
vfor({ counter.list.toObservableList() }) { item ->
    Text {
        attr { text(item) }
    }
}
```

åŸå› è¯´æ˜ï¼š

* `kisstateList` æ˜¯ä¸€ä¸ªå“åº”å¼ä»£ç†å¯¹è±¡
* `vfor` ä¾èµ–çš„æ˜¯ Kuikly å†…éƒ¨çš„ `ObservableList`
* `toObservableList()` ç”¨äºè¿”å›å…¶å†…éƒ¨ç»´æŠ¤çš„åŸå§‹ `ObservableList`

â— **ä¸è°ƒç”¨æ— æ³•ç¼–è¯‘æˆåŠŸ**

---

### 3ï¸âƒ£ è®¡ç®—å±æ€§ï¼ˆ`computed`ï¼‰

`computed` ç”¨äºå£°æ˜**æ´¾ç”ŸçŠ¶æ€**ï¼Œåªåœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—ï¼š

```kotlin
val kisContext = KisContext()

val doubleCount by computed(kisContext) {
    counter.count * 2
}

val listLen by computed(kisContext) {
    counter.list.size
}
```

ç‰¹æ€§ï¼š

* è‡ªåŠ¨ä¾èµ–æ”¶é›†
* å…·å¤‡ç¼“å­˜èƒ½åŠ›
* ä»…åœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—

âš ï¸ **æ‰€æœ‰ `computed` å¿…é¡»ç»‘å®šåˆ° `KisContext`**

---

### 4ï¸âƒ£ å‰¯ä½œç”¨ç›‘å¬ï¼ˆ`watch`ï¼‰

ä½¿ç”¨ `watch` ç›‘å¬çŠ¶æ€å˜åŒ–å¹¶æ‰§è¡Œå‰¯ä½œç”¨é€»è¾‘ã€‚

æ”¯æŒç›‘å¬ï¼š

* `kisstate`
* `kisstateList`
* `computed`
* å¤šä¸ªä¾èµ–ç»„åˆ

---

## å®Œæ•´ç¤ºä¾‹ ğŸš€

```kotlin
class Counter {
    var count by kisstate(0)
    var list by kisstateList<String>()
}

val counter = Counter()

@Page("router", supportInLocal = true)
internal class RouterPage : BasePager() {

    private val kisContext = KisContext()

    val doubleCount by computed(kisContext) {
        counter.count * 2
    }

    val listLen by computed(kisContext) {
        counter.list.size
    }

    override fun body(): ViewBuilder = {
        View {
            attr {
                flex(1f)
                allCenter()
            }

            Text { attr { text("count: ${counter.count}") } }
            Text { attr { text("double count: $doubleCount") } }
            Text { attr { text("list length: $listLen") } }

            Button {
                attr { titleAttr { text("add") } }
                event {
                    click {
                        counter.list.add("item: ${counter.count}")
                        counter.count++
                    }
                }
            }

            Text { attr { text("list:") } }

            // âš ï¸ vfor ä¸­å¿…é¡»ä½¿ç”¨ toObservableList()
            vfor({ counter.list.toObservableList() }) { item ->
                Text {
                    attr { text(item) }
                }
            }
        }
    }

    override fun created() {
        super.created()
        initEffect()
    }

    /**
     * å‰¯ä½œç”¨ç›‘å¬ç»Ÿä¸€åœ¨è¿™é‡Œåˆå§‹åŒ–
     */
    private fun initEffect() {

        // 1ï¸âƒ£ ç›‘å¬ kisstate
        watch(kisContext, { counter.count }) { newV, oldV ->
            println("kissLog count change: $oldV -> $newV")
        }

        // 2ï¸âƒ£ ç›‘å¬ kisstateList
        watch(kisContext, { counter.list }) { newV, oldV ->
            println("kissLog list change: $newV")
        }

        // 3ï¸âƒ£ ç›‘å¬ computed
        watch(kisContext, { doubleCount }) { newV, oldV ->
            println("kissLog doubleCount change: $oldV -> $newV")
        }

        // 4ï¸âƒ£ åŒæ—¶ç›‘å¬å¤šä¸ªä¾èµ–
        watch(
            kisContext,
            {
                listOf(
                    counter.count,
                    counter.list
                )
            }
        ) { newV, oldV ->
            println("kissLog count or list changed")
        }
    }

    override fun pageWillDestroy() {
        super.pageWillDestroy()
        // âš ï¸ éå¸¸é‡è¦ï¼šé‡Šæ”¾æ‰€æœ‰ computed / watch
        kisContext.dispose()
    }
}
```

---

## ç›‘å¬å¤šä¸ªä¾èµ– ğŸ“Œ

```kotlin
watch(kisContext, {
    listOf(counter.count, counter.list)
}) { newV, oldV ->
    // ä»»æ„ä¸€ä¸ªä¾èµ–å˜åŒ–éƒ½ä¼šè§¦å‘
}
```

è¯´æ˜è¦ç‚¹ï¼š

* `watch` çš„ç¬¬ä¸€ä¸ª lambda **åªç”¨äºä¾èµ–æ”¶é›†**
* è¿”å›å€¼æœ¬èº«å¹¶ä¸é‡è¦ï¼Œé€šå¸¸ä½¿ç”¨ `listOf(...)`
* åªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªä¾èµ–å‘ç”Ÿå˜åŒ–ï¼Œå›è°ƒå°±ä¼šæ‰§è¡Œ

é€‚ç”¨åœºæ™¯ï¼š

* å¤šä¸ªçŠ¶æ€å…±åŒå†³å®šä¸€ä¸ªå‰¯ä½œç”¨
* åªå…³å¿ƒâ€œæ˜¯å¦å˜åŒ–â€ï¼Œä¸å…³å¿ƒå…·ä½“æ˜¯å“ªä¸€ä¸ªå˜äº†
* ç”¨äºåˆå¹¶å¤šä¸ª `watch` çš„åœºæ™¯

---

## ç”Ÿå‘½å‘¨æœŸç®¡ç† âš ï¸ï¼ˆéå¸¸é‡è¦ï¼‰

`computed` å’Œ `watch` **ä¸ä¼šè‡ªåŠ¨é”€æ¯**ï¼Œ
å¿…é¡»åœ¨ Page / Component é”€æ¯æ—¶æ‰‹åŠ¨é‡Šæ”¾ï¼š

```kotlin
override fun pageWillDestroy() {
    kisContext.dispose()
    super.pageWillDestroy()
}
```

å¦åˆ™å¯èƒ½å¯¼è‡´ï¼š

* å†…å­˜æ³„æ¼
* é¡µé¢å·²é”€æ¯ä½†ä»ç„¶å“åº”çŠ¶æ€å˜åŒ–

---

## è®¾è®¡ç†å¿µ ğŸ”§

* **æ˜¾å¼ä¾èµ–ï¼Œè€Œééšå¼é­”æ³•**
* **Context å³ä½œç”¨åŸŸ**
* **çŠ¶æ€ â‰  UI**
* **å“åº”å¼ï¼Œä½†å¿…é¡»å¯æ§**

kisstate ä¸è¯•å›¾â€œæ¥ç®¡ä¸€åˆ‡â€ï¼Œ
å®ƒåªä¸“æ³¨ä¸€ä»¶äº‹ï¼š

> **çŠ¶æ€å˜åŒ– â†’ ç²¾å‡†é€šçŸ¥ â†’ å¯é¢„æµ‹æ›´æ–°**

---

## æœ€ä½³å®è·µ âœ…

1. **ä¸šåŠ¡çŠ¶æ€å•ä¾‹åŒ–**

   ```kotlin
   val counter = Counter()
   ```

2. **åœ¨ Page / Component å†…åˆ›å»º `KisContext`**

3. **æ‰€æœ‰ `computed / watch` å¿…é¡»ç»‘å®šåˆ° context**

4. **ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶åŠæ—¶ `dispose()`**

5. **çŠ¶æ€ä¸ UI è§£è€¦ï¼Œæ–¹ä¾¿å¤ç”¨ä¸æµ‹è¯•**

---

## API ä¸€è§ˆ ğŸ“–

| API            | è¯´æ˜           |
| -------------- | ------------ |
| `kisstate`     | åŸºç¡€å“åº”å¼çŠ¶æ€      |
| `kisstateList` | å“åº”å¼åˆ—è¡¨        |
| `computed`     | è®¡ç®—å±æ€§         |
| `watch`        | çŠ¶æ€ç›‘å¬         |
| `KisContext`   | ä½œç”¨åŸŸ & ç”Ÿå‘½å‘¨æœŸç®¡ç† |

---

## License

MIT Â© ailuoku6

---

ğŸ‰ **è®© Kuikly çš„çŠ¶æ€ç®¡ç†å›å½’ç®€å•ï¼**
kisstate ä¸è¿½æ±‚â€œå…¨èƒ½â€ï¼Œ
åªè¿½æ±‚ **å¥½ç†è§£ã€å¥½ä½¿ç”¨ã€ä¸è¸©å‘**ã€‚
